<section>
    <div class="section-bar" #bar>
        <span class="right-spacer" aria-hidden="true"></span>
        <h3 class="section-title">Pray</h3>
        <button mat-icon-button class="close" aria-label="Close" (click)="onClose()">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    @if (selectedItems().length === 0) {
        <div class="prayer-card">
            <div class="empty">No requests yet.</div>
        </div>
    } @else {
        <div class="carousel-viewport" #carousel [style.height.px]="viewportHeight()"
            (pointerdown)="onPointerDown($event)" (pointermove)="onPointerMove($event)"
            (pointerup)="onPointerUp($event)" (pointerleave)="onPointerUp($event)" (pointercancel)="onPointerUp($event)"
            [class.dragging]="isDragging">
            <div class="carousel-track" #track [style.transform]="carouselTransform()" [class.dragging]="isDragging">
                <!-- Settings slide (index 0) -->
                <div class="slide settings-slide">
                    <div class="prayer-card">
                        <div class="controls">
                            @if (maxAnswered > 0) {
                                <div class="control">
                                    <div class="label-value-row">
                                        <div class="label">Start with answered requests</div>
                                        <div class="value">{{ formatAnsweredLabel() }}</div>
                                    </div>
                                    <mat-slider [min]="0" [max]="maxAnswered" [step]="1" [showTickMarks]="true">
                                        <input matSliderThumb [(ngModel)]="answeredValueModel"
                                            (ngModelChange)="onAnsweredChange($event)"
                                            (pointerdown)="$event.stopPropagation()" (click)="$event.stopPropagation()">
                                    </mat-slider>
                                </div>
                            }
                            <div class="control">
                                <div class="label-value-row">
                                    <div class="label">Number of requests</div>
                                    <div class="value">{{ formatCountLabel() }}</div>
                                </div>
                                <mat-slider [min]="1" [max]="safeMaxSelectable" [step]="1" [showTickMarks]="true">
                                    <input matSliderThumb [(ngModel)]="selectCountModel"
                                        (ngModelChange)="onSelectCountChange($event)"
                                        (pointerdown)="$event.stopPropagation()" (click)="$event.stopPropagation()">
                                </mat-slider>
                            </div>
                            <div class="control">
                                <div class="label-value-row">
                                    <div class="label">Time limit</div>
                                    <div class="value">{{ formatTimeLabel() }}</div>
                                </div>
                                <mat-slider [min]="1" [max]="61" [step]="1" [showTickMarks]="true">
                                    <input matSliderThumb [(ngModel)]="timeValueModel"
                                        (ngModelChange)="onTimeChange($event)" (pointerdown)="$event.stopPropagation()"
                                        (click)="$event.stopPropagation()">
                                </mat-slider>
                            </div>
                        </div>
                        <div class="hint">Swipe left to begin</div>
                    </div>
                </div>

                <!-- Prayer slides (index >= 1) -->
                @for (item of selectedItems(); track item.kind + '-' + item.id) {
                    <div class="slide">
                        <div class="prayer-card">
                            @if (item.kind === 'request') {
                                <app-prayer-card icon="favorite" [title]="item.description" [listName]="item.listName"
                                    [topicName]="item.topicName" [createdDate]="item.createdDate"
                                    [prayerCount]="item.prayerCount" [priority]="item.priority"
                                    [isAnswered]="item.isAnswered || false" [answeredDate]="item.answeredDate"
                                    [answerDescription]="item.answerDescription"
                                    (answered)="onRequestAnswered(item.id, $event)"
                                    (archive)="onRequestArchiveButton(item.id)"
                                    (titleEdited)="onTitleEdited(item.id, $event)"
                                    (addNewRequest)="onAddNewRequest($event, $index)">
                                </app-prayer-card>
                            } @else {
                                <app-prayer-card icon="label" [title]="item.name" [listName]="'from ' + item.listName"
                                    (addNewRequest)="onAddNewRequest($event, $index)"></app-prayer-card>
                            }
                        </div>
                    </div>
                }

                <!-- Stats slide (index = selectedItems.length + 1) -->
                <div class="slide">
                    <div class="prayer-card">
                        <app-stats-card [totalItems]="selectedItems().length" [sessionDuration]="sessionDuration()"
                            [prayerCount]="finalPrayerCountValue()" [totalTimePrayed]="prayerStats.getTotalTimePrayed()"
                            [totalRequestsPrayed]="prayerStats.getTotalRequestsPrayed()"
                            [totalRequestsAnswered]="prayerStats.getTotalRequestsAnswered()"
                            [totalRequestsCompleted]="totalRequestsCompleted()"
                            [totalSessions]="prayerStats.getTotalSessions()"
                            [sessionsPerWeek]="prayerStats.getSessionsPerWeek()">
                        </app-stats-card>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="pray-footer" #footer [class.visible]="currentIndex() >= 1 && currentIndex() <= selectedItems().length">
        @if (currentIndex() >= 1) {
            @if (unlimited) {
                <div class="progress-section">
                    <div class="progress-label">Progress</div>
                    <mat-progress-bar mode="determinate" [value]="progressPercent()"></mat-progress-bar>
                </div>
            } @else {
                <div class="progress-section">
                    <div class="progress-label">Time</div>
                    <mat-progress-bar mode="determinate" [value]="timeProgressPercent()"></mat-progress-bar>
                </div>
                <div class="progress-section">
                    <div class="progress-label">Progress</div>
                    <mat-progress-bar mode="determinate" [value]="progressPercent()"></mat-progress-bar>
                </div>
            }
        }
    </div>
</section>

<!-- Answer Dialog -->
<div *ngIf="showAnswerDialog()" class="answer-dialog-overlay" (click)="closeAnswerDialog()">
    <div class="answer-dialog-content" (click)="$event.stopPropagation()">
        <div class="dialog-header">
            <h2>Add Answer</h2>
        </div>
        <p>Request: {{ answerDialogTitle() }}</p>
        <textarea [(ngModel)]="answerDialogText" placeholder="Describe the answer..." rows="4"
            style="width: 100%;"></textarea>
        <div class="dialog-actions">
            <button mat-button style="color: grey;" (click)="closeAnswerDialog()">Cancel</button>
            <button mat-flat-button style="background-color: var(--theme-accent); color: white;"
                (click)="onSaveAnswer()">{{ answerDialogText().trim() ? 'Save' : 'Skip' }}</button>
        </div>
    </div>
</div>

<div [style.display]="showAnswerDialog() ? 'block' : 'none'" class="answer-dialog-overlay"
    (click)="closeAnswerDialog()">
    <div class="answer-dialog-content" (click)="$event.stopPropagation()">
        <div class="dialog-header">
            <h2>Add Answer</h2>
        </div>
        <p>Request: {{ answerDialogTitle() }}</p>
        <textarea [(ngModel)]="answerDialogText" placeholder="Describe the answer..." rows="4"
            style="width: 100%;"></textarea>
        <div class="dialog-actions">
            <button mat-button style="color: grey;" (click)="closeAnswerDialog()">Cancel</button>
            <button mat-flat-button style="background-color: var(--theme-accent); color: white;"
                (click)="onSaveAnswer()">{{ answerDialogText().trim() ? 'Save' : 'Skip' }}</button>
        </div>
    </div>
</div>