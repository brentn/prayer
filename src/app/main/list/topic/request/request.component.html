@if (isEditing) {
    <div class="request-card editing">
        @if (requestState === 'open') {
            <button class="priority-badge" [ngClass]="'priority-' + editingPriority()" (click)="onCyclePriority()"
                [disabled]="!editingText.trim()">
                {{ editingPriority() }}
            </button>
        } @else if (editingPriority() > 1) {
            <div class="priority-dot-static" [ngClass]="'priority-' + editingPriority()"></div>
        }

        @if (requestState === 'open') {
            <textarea class="edit-textarea" rows="3" [value]="editingText"
                (input)="editingText = $any($event.target).value" placeholder="Type your request..."
                autofocus></textarea>
        } @else if (requestState === 'answered') {
            <!-- Show the original request as read-only -->
            <div class="request-text read-only">{{ request.description }}</div>
            <div class="request-date">{{ request.createdDate | date:'short' }}</div>

            <!-- Answer description textarea -->
            <div class="answer-section">
                <label class="answer-label">Answer (optional):</label>
                <textarea class="edit-textarea answer-textarea" rows="2" [value]="editingText"
                    (input)="editingText = $any($event.target).value" placeholder="Add an answer or note..."
                    autofocus></textarea>
            </div>
        }
        <!-- Archived requests don't show editing UI -->

        <div class="inline-actions">
            <div class="left">
                <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="More options">
                    <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menu="matMenu">
                    @if (requestState === 'open') {
                        <button mat-menu-item (click)="onMarkAnswered()" [disabled]="!editingText.trim()">
                            <mat-icon>check</mat-icon>
                            <span>Mark as Answered</span>
                        </button>
                        <button mat-menu-item (click)="onArchive()" [disabled]="!editingText.trim()">
                            <mat-icon>archive</mat-icon>
                            <span>Archive</span>
                        </button>
                        <button mat-menu-item (click)="onDelete()" class="delete-option">
                            <mat-icon>delete</mat-icon>
                            <span>Delete</span>
                        </button>
                    } @else if (requestState === 'answered') {
                        <button mat-menu-item (click)="onMarkUnanswered()">
                            <mat-icon>undo</mat-icon>
                            <span>Mark as Unanswered</span>
                        </button>
                        <button mat-menu-item (click)="onArchive()">
                            <mat-icon>archive</mat-icon>
                            <span>Archive</span>
                        </button>
                    } @else if (requestState === 'archived') {
                        <button mat-menu-item (click)="onUnarchive()" [disabled]="!editingText.trim()">
                            <mat-icon>unarchive</mat-icon>
                            <span>Unarchive</span>
                        </button>
                    }
                </mat-menu>
            </div>
            <div class="right">
                <button mat-button (click)="onCancel()">Cancel</button>
                <button mat-flat-button color="primary" [disabled]="!editingText.trim()" (click)="onSave()">
                    Save
                </button>
            </div>
        </div>
    </div>
} @else {
    <div class="request-card" [class.archived]="requestState === 'archived'"
        (click)="requestState !== 'archived' ? onEdit() : null">
        @if (request.priority && request.priority > 1) {
            <div class="priority-dot-static" [ngClass]="'priority-' + request.priority"></div>
        }
        <div class="request-text">{{ request.description }}</div>
        <div class="request-date">{{ request.createdDate | date:'short' }}</div>

        @if (requestState === 'archived') {
            <div class="archived-actions">
                <button mat-stroked-button (click)="onUnarchive()" color="accent">
                    <mat-icon>unarchive</mat-icon>
                    Unarchive
                </button>
            </div>
        }
    </div>
}