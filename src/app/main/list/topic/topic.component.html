<section (click)="onSectionClick()">
    <div class="section-bar" (click)="$event.stopPropagation()">
        <div class="title-stack" (click)="startEdit()">
            @if (!editing) {
                <h3 class="section-title">{{ (currentTopic()?.name) || 'Topic' }}</h3>
            } @else {
                <input class="edit-input" type="text" [value]="editName" (click)="$event.stopPropagation()"
                    (input)="editName = $any($event.target).value" (keydown.enter)="saveEdit()"
                    (keydown.escape)="cancelEdit()" autofocus />
            }
            @if (currentList(); as l) {
                <div class="section-subtitle">from list: {{ l.name }}</div>
            }
        </div>
        @if (editing) {
            <div class="section-menu">
                @if (requests().length===0) {
                    <button mat-icon-button color="warn" class="trash-btn" [disabled]="requests().length > 0"
                        (click)="onDeleteTopic(); $event.stopPropagation()" aria-label="Delete Topic">
                        <mat-icon class="trash">delete</mat-icon>
                    </button>
                }
            </div>
        }
    </div>

    <mat-tab-group [(selectedIndex)]="activeTabIndex" class="tabs">
        <mat-tab label="Requests">
            <div class="requests" #requestsContainer>
                @for (req of openRequests(); track req.id) {
                    <app-request [request]="req" [isEditing]="editingRequestId === req.id"
                        [editingText]="editingRequestText" [editingPriority]="editingRequestPriority"
                        [requestState]="'open'" (edit)="onEditRequest($event)" (save)="saveInline($event)"
                        (cancel)="cancelInline()" (deleteRequest)="onInlineDelete()"
                        (markAnswered)="markAnsweredInline($event)" (archive)="onArchiveRequest($event)"
                        (cyclePriority)="cyclePriority()">
                    </app-request>
                }
            </div>
        </mat-tab>
        <mat-tab label="Answers">
            <div class="requests">
                @for (req of answeredRequests(); track req.id) {
                    <app-request [request]="req" [isEditing]="editingRequestId === req.id"
                        [editingText]="editingRequestText" [editingPriority]="editingRequestPriority"
                        [requestState]="'answered'" (edit)="onEditRequest($event)" (save)="saveInline($event)"
                        (cancel)="cancelInline()" (markUnanswered)="markUnansweredInline($event)"
                        (archive)="onArchiveRequest($event)" (cyclePriority)="cyclePriority()">
                    </app-request>
                }
            </div>
        </mat-tab>
        <mat-tab label="Archived">
            <div class="requests">
                @for (req of archivedRequests(); track req.id) {
                    <app-request [request]="req" [isEditing]="editingRequestId === req.id"
                        [editingText]="editingRequestText" [editingPriority]="editingRequestPriority"
                        [requestState]="'archived'" (edit)="onEditRequest($event)" (save)="saveInline($event)"
                        (cancel)="cancelInline()" (unarchive)="onUnarchiveRequest($event)"
                        (cyclePriority)="cyclePriority()">
                    </app-request>
                }
            </div>
        </mat-tab>
    </mat-tab-group>

    @if (!editing && editingRequestId === null) {
        <button class="fab mat-mdc-extended-fab" mat-fab color="primary" (click)="onAdd()" aria-label="Add Request">
            <mat-icon>add</mat-icon> Add Request
        </button>
    }
</section>